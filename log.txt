 
USE scOrderReview
GO
--单号,商品id,操作人
CREATE  FUNCTION F_CheckPurchaseItem(@sheetid char(16),@goodsid int,@auth int)
returns nvarchar(256) --没有问题的返回'',有问题返回原因 
AS
BEGIN
DECLARE @rs nvarchar(256)
,
@shopid char(4),
@oqty decimal(12,3),
@oename varchar,
@oeshortname varchar,
@odeptid int,
@ocost decimal(12,4),
@skutype char(1)='A' --怎么取这个值？
SET @rs = ''
SET @shopid = (select ShopID from mySHOPSHStock..PurchaseAsk0 where SheetID=@sheetid)
select @oqty =pai.Qty,@oename =rtrim(g.ename),@oeshortname = rtrim(g.EShortName),@odeptid=g.DeptID,
@ocost=pai.Cost
 from mySHOPSHStock..[PurchaseAskItem0] pai join mySHOPSHStock..Goods g on pai.GoodsID = g.GoodsID where pai.SheetID=@sheetid and @goodsid = pai.GoodsID
if(isnull(@oqty,0) <=0) 
  return @rs

--订货属性值判断
 --1 店铺
 if ((select count(1) from [dbo].[OrderControl] where [TypeID]=1 and shopid=@shopid and [forbidden]=1)>0)   
  set @rs = @rs + '此店不允许订货'
return @rs

--2 毛利属性
 if ((select count(1) from [dbo].[OrderControl] where [TypeID]=2 and shopid=@shopid and code = @oename and [forbidden]=1)>0)   
  set @rs = @rs + '毛利属性 '+@oename+' 不允许订货'
  return @rs
  --3 销售属性
 if ((select count(1) from [dbo].[OrderControl] where [TypeID]=3 and shopid=@shopid and code =@oeshortname and [forbidden]=1)>0)   
  set @rs = @rs + '销售属性 '+@oeshortname+' 不允许订货'
  return @rs
  --4 品类店型组
 if ((select count(1) from [dbo].[OrderControl] where [TypeID]=4 and shopid=@shopid and code = @odeptid and subcode = @skutype and [forbidden]=1)>0)   
  set @rs = @rs +'品类店型组 '+@odeptid+'-'+@skutype+' 不允许订货'
  return @rs



  --用户审批权限属性值 判断
declare 
@multiple numeric(10,2),--倍数
@num numeric(10,2),--数量
@amt money,--金额
@limitnum numeric(10,2),--每日数量上线
@limitamt money,--每日金额上限
@totalnum numeric(10,2),
@totalamt money

select 
@multiple=isnull(fs.ordermultiple,0) ,--倍数*？
@num=isnull(fs.[OrderNum],0),
@amt=isnull(fs.[OrderAmt],0),  
@limitnum=isnull(fs.[DayUpperlimit] ,0), 
@limitamt=isnull(fs.[DayUpperlimitAmt],0) 
 from [dbo].[FunctionSetting] fs where 
fs.FunctionId =@auth  and fs.ShopId = @shopid 


(select @totalnum=sum(Qty),@totalamt=sum(Qty*Cost) from  mySHOPSHStock..PurchaseAskItem where GoodsID = @goodsid )

--倍数 与 数量比较
if(@oqty > @num)
  set @rs = @rs + '数量不能大于 xx 的多少倍' + convert(varchar,@multiple)
return @rs

--数量 与 数量比较
if(@oqty > @num)
  set @rs = @rs + '数量不能大于' + convert(varchar,@num)
return @rs

--金额比较
if(@ocost > @amt)
  set @rs = @rs + '金额不能大于' + convert(varchar,@amt)
return @rs

--单日最大数量比较
if(@oqty+@totalnum> @limitnum  )
  set @rs = @rs + '每日订货数不能大于' + convert(varchar,@limitnum)
return @rs
--单日最大金额比较
if((@oqty*@ocost)+@totalamt > @limitamt  )
  set @rs = @rs + '每日订货金额不能大于' + convert(varchar,@limitamt)
return @rs

RETURN   @rs   
END
GO 

SELECT   dbo.F_CheckPurchaseItem('1111111111111111',1,1)  as a
 

 


--总部店铺
 select * from mySHOPSHStock..Shop  where ShopType in (11,13) and Enable =1
 --店铺店铺
 config表  Name=本店号

 logtime


select * from mySHOPSHStock..MinOrder --普通商品
select * from mySHOPSHStock..GoodsPKNum --配送商品

总部有没有最小订货表，商品进价怎么取  2个报表


总部库名和店铺库名不一致，需要区分开
 909 593 896  jq3p43
路由记住数据
总部和店铺的库名区分




  insert into ${DBOrderReview}..Login ([LoginID]
      ,[Name]
      ,[CName]
      ,[password]
      ,[EnableFlag]
      ,[Note]
      ,[LastModifyDT]
      ,[IsAdmin])
  select  [LoginID],[Name],[CName],[Name],1,note,getdate(),0  from ${DBConnect}..Login a where EnableFlag =1
  and
  not exists (select 1 from ${DBOrderReview}..Login b where a.LoginID =b.LoginID)